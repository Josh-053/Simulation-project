---
title: "PopPK-Based Dosing Optimization for Triazoconazole"
author: "Joshua Ijidakinro, Ali Kazim"
affiliation: "Faculty of Pharmaceutical Science, KU Leuven"
format: pdf
execute:
  echo: true
  warning: false
  message: false
---

# Introduction

Brontogen fibropathy (BF) is an inherited disorder that leads to changes in lung tissue and airflow over time. Patients with BF develop infection from *Spirgilus viridicaulis*, a fungal species that grows in warm and humid regions. This fungus can be treated using the antimycotic drug triazoconazole. This drug is administered to children with BF for off-label use, as it is originally indicated for patients with bronchiectasis.

# Objectives

The purpose of the simulation was to evaluate whether the administered dose of 150 mg once a day evoked sufficient exposure with area under the curve from time zero to 24 hours (AUC~0-24~) of 28 mg·h/L for children with Brontogen fibropathy. The goal was also to suggest an optimal dosing regimen based on the simulation results.

# Methods

A study of 33 adolescent patients was simulated over 1000 replicates, resulting in a total of 33000 simulated patients. The simulation was performed using `mrgsolve` package in `R`. A dosing event was created for the administered regimen of **150 mg q24h**, which was used to simulate the individual predicted plasms concentration-time profile (IPRED) and the cumulative area under the curve (cAUC). AUC~0-24~ was calculated using the **continuous AUC integration** method of adding cAUC from 0 to 24 hours. Five empirical dosing regimens were simulated in the same manner as the administered regimen, these were as follows: **150 mg q8h, 150 mg q12h, 200 mg q24h, 240 mg q24h and 300 mg q24h**. Higher doses were selected based on the assumption of dose proportionality []. The next page shows the simulation model script.


```{r packages}
#| include: false

if (!require("pacman")) {
  install.packages("pacman")
  library(pacman)}

pacman::p_load(mrgsolve,
               ggplot2,
               kableExtra,
               tidyverse,
               patchwork)
```

{{< pagebreak >}} 

## Simulation Code

```{cpp}
$PARAM
TVCL   = 7.95,  // L/h
TVV    = 190,   // L 
TVka   = 0.17,  // 1/h

$CMT DEPOT CENT cAUC // 1-compartmental model with absorption

$INPUT BW = 38 // kg, covariate which has effect on PK parameters

$MAIN
double BWEffCL = 0.75    ; // BW effect on CL
double BWEffV  = 1       ; // BW effect on V
double BWEffka = -(0.25) ; // BW effect on ka

double CL  = TVCL * pow((BW/70),BWEffCL) * exp(ETA(1));
double V   = TVV  * pow((BW/70),BWEffV)               ;
double ka  = TVka * pow((BW/70),BWEffka)              ;
// power function for scaling

double k10 = CL/V ; 

$OMEGA
0.1415863641 // CV_CL = 39%

$SIGMA
0.0974896213 // EPS(1)
0.0324       // EPS(2)

$ODE
dxdt_DEPOT   = -(ka) * DEPOT                 ;
dxdt_CENT    =  (ka) * DEPOT  - (k10) * CENT ;
dxdt_cAUC    =                  CENT/V       ;

$TABLE 
double IPRED  = CENT/V                        ; 
double DV     = IPRED * (1+EPS(1)) + EPS(2)   ;
double BWsim  = BW                            ;

$CAPTURE
IPRED
```

# Results

```{r}
#| echo: false
mod <- mread("project")
```

```{r parameters}
#| echo: false
set.seed(123)      # reproducibility

N      <- 1000L    # number of replicates
N_id   <- 33L      # number of patients per replicate
delta  <- 0.1      # hours (h)
tot_id <- N * N_id
```

```{r}
#| echo: false
ev1 <- ev(amt = 150, time = 0)
ev2 <- ev(amt = 150, time = 0, ii = 12, addl = 1)
ev3 <- ev(amt = 150, time = 0, ii = 8,  addl = 2)
ev4 <- ev(amt = 200, time = 0)
ev5 <- ev(amt = 240, time = 0)
ev6 <- ev(amt = 300, time = 0)

# Force a grid that includes 24 exactly
tg <- tgrid(start = 0, end = 24, delta = delta)


run_regimen <- function(ev_obj, label) {
  out <- mrgsim(mod %>% init(cAUC = 0),
                e      = ev_obj,
                nid    = tot_id,
                tgrid  = tg,
                output = "df")
  
  rows24  <- out$time == 24
  auc_vec <- out$cAUC[rows24]
 
   # Robustness check: should have one AUC per ID
  stopifnot(length(auc_vec) == tot_id)
  
  list(sim = transform(out, regimen = label),
       auc = data.frame(regimen = label, AUC_0_24 = auc_vec))
}
```

```{r}
#| echo: false
res_24_150 <- run_regimen(ev1, "150 mg q24h")
res_12_150 <- run_regimen(ev2, "150 mg q12h")
res_08_150 <- run_regimen(ev3, "150 mg q8h")
res_24_200 <- run_regimen(ev4, "200 mg q24h")
res_24_240 <- run_regimen(ev5, "240 mg q24h")
res_24_300 <- run_regimen(ev6, "300 mg q24h")

sim_all <- bind_rows(res_24_150$sim, res_12_150$sim, res_08_150$sim,
                     res_24_200$sim, res_24_240$sim, res_24_300$sim)
auc_all <- bind_rows(res_24_150$auc, res_12_150$auc, res_08_150$auc,
                     res_24_200$auc, res_24_240$auc, res_24_300$auc)
```

The study suggests that the dosing regimen of **150 mg q24h** elicits an AUC~0-24~ of 17.69 mg·h/L, which is below the anticipated exposure of 28 mg·h/L. Based on these results, dosing regimens (**150 mg q8h, 240 mg q24h or 300 mg q24h**) are proposed.

```{r}
#| echo: false
auc_summary <- auc_all %>%
  group_by(regimen) %>%
  summarize(median_AUC_0_24 = median(AUC_0_24),
            mean_AUC_0_24   = mean(AUC_0_24),
            sd_AUC_0_24     = sd(AUC_0_24),
            .groups = "drop")

auc_summary %>%
  kable(
    format   = "latex", # PDF/LaTeX output
    booktabs = TRUE,    # nicer horizontal rules
    digits   = 2,       # numeric rounding
    caption  = "AUC (0–24 h) Summary by Regimen",
    col.names = c("Regimen", "Median", "Mean", "SD"),
    align    = c("l", "r", "r", "r"),
    longtable = TRUE
  )
```


```{r}
#| echo: false
ipred_summary<- sim_all %>%
  group_by(regimen, time) %>%
  summarize(IPRED_median = median(IPRED),
            IPRED_lo     = quantile(IPRED, 0.025),
            IPRED_hi     = quantile(IPRED, 0.975),
            .groups = "drop")

ggplot(ipred_summary,
       aes(x = time,
           color = regimen)) +
  geom_ribbon(aes(ymin = IPRED_lo,
                  ymax = IPRED_hi,
                  fill = regimen),
              alpha = 0.15,
              color = NA)+
  geom_line(aes(y = IPRED_median),
            linewidth = 1) +
  scale_color_manual(values = c("red", "darkorange", "gold",
                                "forestgreen", "blue", "purple")) +
  scale_fill_manual(values =  c("red", "darkorange", "gold",
                                "forestgreen", "blue", "purple")) +
  guides(fill="none") +
  labs(
    title = "Regimen comparison: IPRED median profiles",
    x = "Time (h)",
    y = "Concentration (IPRED)",
    color = "Regimen") +
  theme_minimal() 
```

# Conclusion

